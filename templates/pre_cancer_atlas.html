<!DOCTYPE html>
<html>
<head>
    <title>Gene Count Boxplot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='index_styles.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">

</head>
<body>
    <h1>Ovarian Cancer Pre-cancer Atlas</h1>

    <div class="view-toggle">
        <p>Select the type of visualization you would like to explore:</p>
        <label>
            <input type="radio" name="view-mode" value="expression">
            Gene expression boxplot
        </label>
        <label>
            <input type="radio" name="view-mode" value="correlation">
            Gene correlation
        </label>
    </div>

    <section id="expressionSection" class="hidden">
        <p>Please enter a gene name and select a category if desired:</p>
        <form id="plotForm" onsubmit="generatePlot(); return false;">
            <div class="form-field">
                <label for="type">Select Type:</label>
                <select name="type" id="type">
                    <option value="epithelium">Epithelium</option>
                    <option value="stroma">Stroma</option>
                </select>
            </div>

            <div class="form-field gene-field">
                <label for="gene">Enter Gene:</label>
                <div class="gene-input-wrapper">
                    <input
                        type="text"
                        id="gene"
                        name="gene"
                        placeholder="Enter gene name"
                        autocomplete="off"
                        required>
                    <div id="gene-suggestions" class="gene-suggestions hidden"></div>
                </div>
            </div>

            <div class="form-field">
                <label for="selection">(Optional) Select Category:</label>
                <select name="selection" id="selection">
                    <option value="">None</option>
                    <option value="p53 pattern">p53 pattern</option>
                    <option value="Decision Tree">Path</option>
                    <option value="Morphology category">Morphology category</option>
                    <option value="BRCA category">BRCA category</option>
                </select>
            </div>

            <button type="submit" class="form-submit">Generate Plot</button>
        </form>
    </section>

    <section id="correlationSection" class="hidden">
        <p>Please enter a category and two genes to view their correlation:</p>
        <form id="correlationForm" onsubmit="generateCorrelation(); return false;">
            <div class="form-field">
                <label for="corCategory">Select Category:</label>
                <select name="category" id="corCategory">
                    <option value="diagnosis" selected>Diagnosis</option>
                    <option value="molecular">Molecular category</option>
                    <option value="decision-tree">Path</option>
                    <option value="morphology">Morphology category</option>
                    <option value="brca">BRCA category</option>
                </select>
            </div>

            <div class="form-field hidden detail-field" id="categoryDetailWrapper">
                <span class="detail-label">Select group(s):</span>
                <details class="multi-select" id="categoryDetailDropdown">
                    <summary id="categoryDetailSummary">Select group(s)</summary>
                    <div id="categoryDetailOptions" class="multi-select-options"></div>
                </details>
            </div>

            <div class="form-field gene-input-line">
                <label for="geneA">Enter Gene A:</label>
                <div class="gene-input-wrapper">
                    <input
                        type="text"
                        id="geneA"
                        name="geneA"
                        placeholder="Enter first gene"
                        autocomplete="off"
                        required>
                    <div id="geneA-suggestions" class="gene-suggestions hidden"></div>
                </div>
            </div>

            <div class="form-field gene-input-line">
                <label for="geneB">Enter Gene B:</label>
                <div class="gene-input-wrapper">
                    <input
                        type="text"
                        id="geneB"
                        name="geneB"
                        placeholder="Enter second gene"
                        autocomplete="off"
                        required>
                    <div id="geneB-suggestions" class="gene-suggestions hidden"></div>
                </div>
            </div>

            <button type="submit" class="form-submit">Generate Correlation</button>
        </form>

        <div id="correlationResult" class="hidden">
            <div id="correlationPlot"></div>
            <div id="correlationStats" class="correlation-stats"></div>
        </div>
        <div id="correlationError" style="color: red;"></div>
    </section>

    <div id="plot"></div>
    <div id="additionalPlot"></div>
    <div id="selectionPlot"></div>
    <div id="error" style="color: red;"></div>

    <script>
        const viewRadios   = document.querySelectorAll('input[name="view-mode"]');
        const expressionSection = document.getElementById("expressionSection");
        const correlationSection = document.getElementById("correlationSection");
        const geneInput = document.getElementById("gene");
        const geneSuggestions = document.getElementById("gene-suggestions");
        const geneAInput = document.getElementById("geneA");
        const geneASuggestions = document.getElementById("geneA-suggestions");
        const geneBInput = document.getElementById("geneB");
        const geneBSuggestions = document.getElementById("geneB-suggestions");

        const categorySelect  = document.getElementById("corCategory");
        const categoryDetailWrapper = document.getElementById("categoryDetailWrapper");
        const categoryDetailDropdown = document.getElementById("categoryDetailDropdown");
        const categoryDetailOptions = document.getElementById("categoryDetailOptions");
        const categoryDetailSummary = document.getElementById("categoryDetailSummary");
        const correlationForm = document.getElementById("correlationForm");
        const correlationResult = document.getElementById("correlationResult");
        const correlationPlotDiv = document.getElementById("correlationPlot");
        const correlationStatsDiv = document.getElementById("correlationStats");
        const correlationError = document.getElementById("correlationError");

        function setupGeneAutocomplete(inputElement, suggestionElement) {
          if (!inputElement || !suggestionElement) {
            return;
          }

          const normalize = value => (value || "").trim().toUpperCase();
          let controller = null;

          const clear = () => {
            suggestionElement.innerHTML = "";
            suggestionElement.classList.add("hidden");
          };

          const show = names => {
            suggestionElement.innerHTML = "";
            if (!names || names.length === 0) {
              const empty = document.createElement("div");
              empty.className = "gene-suggestion empty";
              empty.textContent = "No matching genes";
              suggestionElement.appendChild(empty);
            } else {
              names.forEach(name => {
                const option = document.createElement("button");
                option.type = "button";
                option.className = "gene-suggestion";
                option.textContent = name;
                option.addEventListener("mousedown", event => {
                  event.preventDefault();
                  inputElement.value = name;
                  clear();
                });
                suggestionElement.appendChild(option);
              });
            }
            suggestionElement.classList.remove("hidden");
          };

          const update = term => {
            if (controller) {
              controller.abort();
              controller = null;
            }

            if (!term || term.length < 1) {
              clear();
              return;
            }

            const newController =
              typeof AbortController !== "undefined" ? new AbortController() : null;
            controller = newController;
            const fetchOptions = newController ? { signal: newController.signal } : {};

            fetch(`/genes?q=${encodeURIComponent(term)}`, fetchOptions)
              .then(res => (res.ok ? res.json() : []))
              .then(names => {
                show(names);
                controller = null;
              })
              .catch(err => {
                if (!err || err.name !== "AbortError") {
                  console.error("Gene suggestion lookup failed", err);
                }
                controller = null;
                clear();
              });
          };

          inputElement.addEventListener("input", event => {
            const value = normalize(event.target.value);
            if (event.target.value !== value) {
              event.target.value = value;
            }
            update(value);
          });

          inputElement.addEventListener("focus", event => {
            const value = normalize(event.target.value);
            if (event.target.value !== value) {
              event.target.value = value;
            }
            update(value);
          });

          inputElement.addEventListener("blur", () => {
            setTimeout(() => {
              clear();
            }, 120);
          });
        }

        setupGeneAutocomplete(geneInput, geneSuggestions);
        setupGeneAutocomplete(geneAInput, geneASuggestions);
        setupGeneAutocomplete(geneBInput, geneBSuggestions);

        function resetCorrelationOutput(clearError = true) {
          if (correlationPlotDiv) {
            correlationPlotDiv.innerHTML = "";
          }
          if (correlationStatsDiv) {
            correlationStatsDiv.textContent = "";
          }
          if (correlationResult) {
            correlationResult.classList.add("hidden");
          }
          if (clearError && correlationError) {
            correlationError.textContent = "";
          }
        }

        const categoryDetails = {
          molecular: [
            { value: "NFT", label: "NFT" },
            { value: "Dormant", label: "Dormant" },
            { value: "Mixed", label: "Mixed" },
            { value: "Immunoreactive", label: "Immunoreactive" },
            { value: "Proliferative", label: "Proliferative" },
            { value: "HGSC", label: "HGSC" }
          ],
          "decision-tree": [
            { value: "Path 1", label: "Path 1" },
            { value: "Path 2", label: "Path 2" },
            { value: "Path 3", label: "Path 3" },
            { value: "Path 4", label: "Path 4" },
            { value: "Path 5", label: "Path 5" }
          ],
          morphology: [
            { value: "Flat", label: "Flat" },
            { value: "BLAD", label: "BLAD" }
          ],
          brca: [
            { value: "BRCA1", label: "BRCA1" },
            { value: "BRCA2", label: "BRCA2" },
            { value: "Negative", label: "Negative" },
            { value: "Other", label: "Other" }
          ],
          diagnosis: [
            { value: "NFT", label: "NFT" },
            { value: "p53 sig", label: "p53 signature" },
            { value: "STIL", label: "STIL" },
            { value: "STIC", label: "STIC" },
            { value: "HGSC", label: "HGSC" }
          ]
        };

        function updateViewMode() {
          let activeMode = null;
          viewRadios.forEach(radio => {
            if (radio.checked) {
              activeMode = radio.value;
            }
          });

          if (activeMode === "expression") {
            expressionSection.classList.remove("hidden");
            correlationSection.classList.add("hidden");
            resetCorrelationOutput(true);
          } else if (activeMode === "correlation") {
            correlationSection.classList.remove("hidden");
            expressionSection.classList.add("hidden");
          } else {
            expressionSection.classList.add("hidden");
            correlationSection.classList.add("hidden");
            resetCorrelationOutput(true);
          }

          if (activeMode !== "expression") {
            const plotImg = document.getElementById("plot");
            const additionalImg = document.getElementById("additionalPlot");
            const selectionImg = document.getElementById("selectionPlot");
            if (plotImg) plotImg.innerHTML = "";
            if (additionalImg) additionalImg.innerHTML = "";
            if (selectionImg) selectionImg.innerHTML = "";
          }
        }

        viewRadios.forEach(radio => {
          radio.addEventListener("change", updateViewMode);
        });

        updateViewMode();

        function resetCategoryDetail() {

          categoryDetailOptions.innerHTML = "";
          categoryDetailSummary.textContent = "Select group(s)";
          if (categoryDetailDropdown) {
            categoryDetailDropdown.open = false;
          }
          categoryDetailWrapper.classList.add("hidden");
        }

        function getSelectedDetailInputs() {
          if (!categoryDetailOptions) {
            return [];
          }
          return Array.from(
            categoryDetailOptions.querySelectorAll('input[type="checkbox"]:checked')
          );
        }

        function getSelectedDetailValues() {
          return getSelectedDetailInputs()
            .filter(input => input.name === "category_detail")
            .map(input => input.value);
        }

        function syncSelectAllState() {
          if (!categoryDetailOptions) {
            return;
          }
          const selectAllCheckbox = categoryDetailOptions.querySelector(
            'input[type="checkbox"][name="category_detail_all"]'
          );
          if (!selectAllCheckbox) {
            return;
          }
          const detailCheckboxes = categoryDetailOptions.querySelectorAll(
            'input[type="checkbox"][name="category_detail"]'
          );
          if (!detailCheckboxes.length) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
            return;
          }
          const checkedCount = Array.from(detailCheckboxes).filter(cb => cb.checked).length;
          selectAllCheckbox.checked = checkedCount === detailCheckboxes.length;
          selectAllCheckbox.indeterminate =
            checkedCount > 0 && checkedCount < detailCheckboxes.length;
        }

        function updateCategoryDetailSummary() {
          const checkedInputs = getSelectedDetailInputs();
          const selectAllCheckbox = categoryDetailOptions
            ? categoryDetailOptions.querySelector('input[type="checkbox"][name="category_detail_all"]')
            : null;
          const selectAllChecked = selectAllCheckbox ? selectAllCheckbox.checked : false;

          const detailInputs = checkedInputs.filter(
            input => input.name === "category_detail"
          );
          if (selectAllChecked && detailInputs.length > 0) {
            categoryDetailSummary.textContent = "All selected";
            return;
          }

          const labels = detailInputs.map(
            input => input.dataset.label || input.value
          );
          if (labels.length === 0) {
            categoryDetailSummary.textContent = "Select group(s)";
          } else if (labels.length <= 2) {
            categoryDetailSummary.textContent = labels.join(", ");
          } else {
            categoryDetailSummary.textContent = `${labels.length} selected`;
          }
        }

        function populateCategoryDetail(items) {
          const previousInputs = getSelectedDetailInputs();
          const previouslySelected = new Set(
            previousInputs
              .filter(input => input.name === "category_detail")
              .map(input => input.value)
          );
          const previousSelectAll = previousInputs.some(
            input =>
              input.name === "category_detail_all" &&
              typeof input.checked === "boolean" &&
              input.checked
          );

          categoryDetailOptions.innerHTML = "";
          let selectAllCheckbox = null;

          if (items.length > 0) {
            const selectAllLabel = document.createElement("label");
            selectAllLabel.className = "multi-option select-all-option";

            selectAllCheckbox = document.createElement("input");
            selectAllCheckbox.type = "checkbox";
            selectAllCheckbox.name = "category_detail_all";
            selectAllCheckbox.value = "*";
            selectAllCheckbox.dataset.label = "Select all";
            selectAllCheckbox.checked =
              previousSelectAll || previouslySelected.size === items.length;
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.addEventListener("change", event => {
              const checked = event.target.checked;
              categoryDetailOptions
                .querySelectorAll('input[type="checkbox"][name="category_detail"]')
                .forEach(cb => {
                  cb.checked = checked;
                });
              updateCategoryDetailSummary();
              syncSelectAllState();
            });

            const allSpan = document.createElement("span");
            allSpan.textContent = "Select all";

            selectAllLabel.appendChild(selectAllCheckbox);
            selectAllLabel.appendChild(allSpan);
            categoryDetailOptions.appendChild(selectAllLabel);
          }

          items.forEach(item => {
            const optionLabel = document.createElement("label");
            optionLabel.className = "multi-option";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.name = "category_detail";
            checkbox.value = item.value;
            checkbox.dataset.label = item.label;
            if (
              (selectAllCheckbox && selectAllCheckbox.checked) ||
              previouslySelected.has(item.value)
            ) {
              checkbox.checked = true;
            }
            checkbox.addEventListener("change", () => {
              updateCategoryDetailSummary();
              syncSelectAllState();
            });

            const span = document.createElement("span");
            span.textContent = item.label;

            optionLabel.appendChild(checkbox);
            optionLabel.appendChild(span);
            categoryDetailOptions.appendChild(optionLabel);
          });

          syncSelectAllState();
          updateCategoryDetailSummary();
          if (categoryDetailDropdown) {
            categoryDetailDropdown.open = false;
          }
          categoryDetailWrapper.classList.remove("hidden");
        }

        function refreshCategoryDetail() {
          const value = categorySelect.value;
          if (categoryDetails[value] && categoryDetails[value].length > 0) {
            populateCategoryDetail(categoryDetails[value]);
          } else {
            resetCategoryDetail();
          }
          resetCorrelationOutput(false);
        }

        categorySelect.addEventListener("change", refreshCategoryDetail);

        resetCategoryDetail();
        refreshCategoryDetail();

        document.addEventListener("click", event => {
          if (
            categoryDetailDropdown &&
            categoryDetailDropdown.open &&
            !categoryDetailDropdown.contains(event.target)
          ) {
            categoryDetailDropdown.open = false;
          }
        });

        function generateCorrelation() {
          if (!geneAInput || !geneBInput) {
            return false;
          }

          const geneAValue = (geneAInput.value || "").trim().toUpperCase();
          const geneBValue = (geneBInput.value || "").trim().toUpperCase();
          geneAInput.value = geneAValue;
          geneBInput.value = geneBValue;

          if (!geneAValue || !geneBValue) {
            correlationError.textContent = "Please enter both gene names.";
            return false;
          }

          const formData = new FormData();
          formData.append("geneA", geneAValue);
          formData.append("geneB", geneBValue);
          formData.append("type", "epithelium");

          const categoryValue = categorySelect ? categorySelect.value : "";
          if (categoryValue) {
            formData.append("category", categoryValue);
          }

          const detailValues = getSelectedDetailValues();
          const requiresDetail =
            categoryDetailWrapper &&
            !categoryDetailWrapper.classList.contains("hidden") &&
            detailValues.length === 0;

          if (requiresDetail) {
            correlationError.textContent =
              "Please select at least one detail option.";
            return false;
          }

          detailValues.forEach(value => formData.append("category_detail", value));

          resetCorrelationOutput(true);
          if (categoryDetailDropdown) {
            categoryDetailDropdown.open = false;
          }

          fetch("/pre_cancer_correlation", {
            method: "POST",
            body: formData
          })
            .then(res => {
              if (res.ok) {
                return res.json();
              }
              return res
                .json()
                .catch(() => ({}))
                .then(body => {
                  const message =
                    body && typeof body.error === "string"
                      ? body.error
                      : "Unable to generate correlation.";
                  throw new Error(message);
                });
            })
            .then(data => {
              if (!data || !data.plot_url) {
                throw new Error("Correlation plot is unavailable.");
              }
              correlationPlotDiv.innerHTML =
                `<img src="${data.plot_url}" alt="Correlation plot" class="correlation-image">`;
              const fragments = [];
              if (data.stats_text) {
                fragments.push(`<span class="stat-line">${data.stats_text}</span>`);
              }
              if (data.summary) {
                const summaryParts = (data.summary || "").split(";");
                summaryParts
                  .map(part => part.trim())
                  .filter(Boolean)
                  .forEach(part => {
                    fragments.push(`<span class="stat-line">${part}</span>`);
                  });
              }
              correlationStatsDiv.innerHTML = fragments.join("");
              correlationResult.classList.remove("hidden");
              correlationError.textContent = "";
            })
            .catch(err => {
              correlationError.textContent =
                err && err.message
                  ? err.message
                  : "Unable to generate correlation.";
            });

          return false;
        }

        function generatePlot() {
          const form      = document.getElementById("plotForm");
          const geneValue = (geneInput.value || "").trim().toUpperCase();
          geneInput.value = geneValue;

          const formData = new FormData(form);
          const selCat   = formData.get("selection") || "";
          formData.set("gene", geneValue);
      
          fetch("/pre_cancer_atlas", {
            method: "POST",
            body: formData
          })
          .then(res => {
            if (!res.ok) {
              return res.json().then(j => { throw new Error(j.error); });
            }
            return res.json();
          })
          .then(data => {
            // Always show first plot (Diagnosis)
            document.getElementById("plot").innerHTML =
              `<img src="${data.plot_url1}" alt="Boxplot of Pathologic Diagnosis">`;

            // Now handle the second plot (Molecular subtype)
            const secondDiv = document.getElementById("additionalPlot");
            const thirdDiv  = document.getElementById("selectionPlot");
            secondDiv.innerHTML = "";
            thirdDiv.innerHTML  = "";

            if (typeof data.plot_url2 === "string" && data.plot_url2.startsWith("data:image")) {
              secondDiv.innerHTML =
                `<img src="${data.plot_url2}" alt="Boxplot of Molecular Subtype">`;
            }

            if (
              typeof data.plot_url3 === "string" &&
              data.plot_url3.startsWith("data:image")
            ) {
              const label = selCat ? selCat : "Selected category";
              thirdDiv.innerHTML =
                `<img src="${data.plot_url3}" alt="Boxplot of ${label}">`;
            }

            // Clear any error
            document.getElementById("error").innerText = "";
          })
          .catch(err => {
            document.getElementById("plot").innerHTML          = "";
            document.getElementById("additionalPlot").innerHTML = "";
            document.getElementById("error").innerText         = err.message;
          });
        }
      </script>
</body>
</html>
