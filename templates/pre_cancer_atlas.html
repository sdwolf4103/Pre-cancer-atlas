<!DOCTYPE html>
<html>
<head>
    <title>Ovarian Pre-cancer Atlas</title>
    <meta name="title" content="Ovarian Pre-Cancer Atlas ‚Äì Spatial Transcriptomic Explorer">
    <meta name="description" content="Interactive platform for exploring ovarian precursor lesions and integrated spatial transcriptomic data.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="ovarian cancer, STIC, STIL, fallopian tube, spatial transcriptomics, GeoMx, precursor lesions, HGSC, high-grade serous carcinoma, gene expression, molecular subtypes">
    <meta name="robots" content="index, follow">
    <meta name="author" content="Shih Lab, Johns Hopkins University">
    <meta name="msvalidate.01" content="F0782A13CB8C3F8B1598CA131B513A35">
    <link rel="canonical" href="https://ovarian-precancer-atlas.gynecologycancer.org/">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;600&family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='index_styles.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/Logo_1_no_words.png') }}">
    <style>
        .citation-box {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 10px 0;
            border: 1px solid #e9ecef;
            max-width: 100%;
        }
        .citation-box p {
            margin: 0;
            font-family: 'Lato', sans-serif; /* Match site font or keep monospace if preferred */
            font-size: 0.9em;
            color: #495057;
            line-height: 1.4;
            margin-right: 15px;
        }
        .copy-btn {
            background: none;
            border: none;
            padding: 5px;
            cursor: pointer;
            color: #6c757d;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .copy-btn:hover {
            color: #007bff;
            background-color: #e9ecef;
        }
        .copy-btn.copied {
            color: #28a745;
        }
        .hidden {
            display: none !important;
        }
    </style>

</head>
<body>
<header class="site-hero">
    <div class="hero-bg"></div>
    <div class="hero-content">
        <div class="hero-heading">
            <a
                href="https://gynecologycancer.org/"
                class="logo-link"
                target="_blank"
                rel="noopener noreferrer"
            >
                <img
                    src="{{ url_for('static', filename='img/Logo_1.png') }}"
                    alt="Ovarian Pre-cancer Atlas logo"
                    class="site-logo"
                >
            </a>
            <div class="hero-text">
                <h1 class="page-title">Ovarian Pre-cancer Atlas</h1>
                <p class="page-subtitle">An interactive atlas of gene expression across fallopian tube epithelium and precursor lesions derived from NanoString GeoMx spatial transcriptomic data.</p>
                <nav class="primary-nav" aria-label="Primary navigation">
                    <ul class="nav-list">
                        <li><a class="nav-link" href="#home" data-view-target="home">Home</a></li>
                        <li class="nav-item--has-dropdown">
                            <button class="nav-link dropdown-toggle" type="button" aria-haspopup="true" aria-expanded="false">
                                Gene Explore
                            </button>
                            <ul class="nav-dropdown">
                                <li><a class="nav-link" href="#expressionSection" data-view-target="expression">Gene Expression</a></li>
                                <li><a class="nav-link" href="#correlationSection" data-view-target="correlation">Gene Correlation</a></li>
                                <li><a class="nav-link" href="#heatmapSection" data-view-target="heatmap">Heatmap</a></li>
                            </ul>
                        </li>
                        <li><a class="nav-link" href="#citation" data-view-target="citation">How to Cite</a></li>
                        <li><a class="nav-link" href="#about" data-view-target="about">About Us</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</header>
<main class="page-content page-background">

    <section id="home" class="home-section">
        <div class="home-intro">
            <p>
                The Ovarian Pre-cancer Atlas is developed by the
                <a href="https://gynecologycancer.org/" target="_blank" rel="noopener noreferrer">Shih Laboratory at Johns Hopkins University</a>
                to share spatial transcriptomic insights on precursor lesions of ovarian cancer. Our goal
                is to provide the research community with intuitive tools to explore gene expression
                patterns across the fallopian tube epithelium and associated precancerous lesions.
            </p>
            <p>
                You may search genes of interest to inquire mRNA expression levels and compare them in normal
                fallopian tube epithelium, high-grade serous carcinoma, and various types of precancerous lesions
                including STIC and p53 signatures. In the forthcoming version, the integrated morphology, multi-omic
                data, and relevant clinical information will be available.
            </p>
        </div>
        <figure class="home-figure">
            <img
                src="{{ url_for('static', filename='img/STIC.png') }}"
                alt="STIC illustration"
            >
            <figcaption>Illustration showing the stepwise transformation of fallopian tube epithelium: (top) p53 signature; (middle) transition to active STIC; (bottom) invasion leading to HGSC.</figcaption>
        </figure>
    </section>

    <section class="expression-intro" data-view-section="expression">
        <h2>Gene Expression across Ovarian Precancerous Lesions</h2>
        <p>
            Explore modeled RNA expression across normal fallopian tube epithelium, precursor lesions, and high-grade serous carcinoma using NanoString GeoMx DSP data.
        </p>
        <details class="how-to-details">
            <summary>üí° How to Use</summary>
            <div class="how-to-panel">
                <ol>
                    <li><strong>Select Type:</strong> Choose Epithelium or Stroma to define the tissue compartment.</li>
                    <li><strong>Enter Gene:</strong> Type an official gene symbol (e.g., SOX4, MMP7, CD74).</li>
                    <li><strong>(Optional) Select Category:</strong> Add an additional plot to compare STIC separated by morphology category (Flat and BLAD).</li>
                    <li><strong>Click Generate Plot:</strong> Boxplots will display expression levels across lesion groups.</li>
                </ol>
                <p class="how-to-note">
                    <strong>Note on ‚Äú*‚Äù:</strong> The asterisk marks groups whose group mean is above or below the NFT (normal fallopian tube epithelium)
                    mean based on a simple reference comparison computed in Python. It is a visual cue only and does not indicate statistical significance
                    (no p-value). For formal differential expression or significance testing, please use DESeq2 (or an equivalent method).
                </p>
            </div>
        </details>
    </section>

    <section id="expressionSection" class="hidden">
        <form id="plotForm" onsubmit="generatePlot(); return false;">
            <div class="form-field">
                <label for="type">Select Type:</label>
                <select name="type" id="type">
                    <option value="epithelium">Epithelium</option>
                    <option value="stroma">Stroma</option>
                </select>
            </div>

            <div class="form-field gene-field">
                <label for="gene">Enter Gene:</label>
                <div class="gene-input-wrapper">
                    <input
                        type="text"
                        id="gene"
                        name="gene"
                        placeholder="Enter gene name"
                        autocomplete="off"
                        required>
                    <div id="gene-suggestions" class="gene-suggestions hidden"></div>
                </div>
            </div>

            <div class="form-field">
                <label for="selection">(Optional) Select Category:</label>
                <select name="selection" id="selection">
                    <option value="">None</option>
                    <option value="Morphology category">Morphology category</option>
                </select>
            </div>

            <button type="submit" class="form-submit" id="generatePlotButton">
                <span class="label">Generate Plot</span>
                <span class="loading-spinner" aria-hidden="true"></span>
            </button>
        </form>
    </section>

    <section id="correlationSection" class="hidden">
        <div class="correlation-intro">
            <h2>Gene Correlation across Ovarian Precancerous Lesions</h2>
            <p>
                Explore the relationship between two genes across selected lesion groups using mRNA expression data
                from NanoString GeoMx spatial transcriptomics.
            </p>
            <details class="how-to-details">
                <summary>üí° How to Use</summary>
                <div class="how-to-panel">
                    <ol>
                        <li><strong>Select Category:</strong> Choose a grouping variable (e.g., Diagnosis, Morphology category, or Molecular subtype).</li>
                        <li><strong>Select Group(s):</strong> Choose one or multiple lesion groups to include in the correlation analysis.</li>
                        <li><strong>Enter Gene A and Gene B:</strong> Input two official gene symbols (e.g., IGFBP2 and MMP7).</li>
                        <li><strong>Click ‚ÄúGenerate Correlation‚Äù:</strong> A scatter plot will display gene expression correlation across the selected groups.</li>
                    </ol>
                </div>
            </details>
        </div>
        <form id="correlationForm" onsubmit="generateCorrelation(); return false;">
            <div class="form-field">
                <label for="corCategory">Select Category:</label>
                <select name="category" id="corCategory">
                    <option value="diagnosis" selected>Diagnosis</option>
                    <option value="molecular">Molecular category</option>
                    <option value="morphology">Morphology category</option>
                </select>
            </div>

            <div class="form-field hidden detail-field" id="categoryDetailWrapper">
                <span class="detail-label">Select group(s):</span>
                <details class="multi-select" id="categoryDetailDropdown">
                    <summary id="categoryDetailSummary">Select group(s)</summary>
                    <div id="categoryDetailOptions" class="multi-select-options"></div>
                </details>
            </div>

            <div class="form-field gene-input-line">
                <label for="geneA">Enter Gene A:</label>
                <div class="gene-input-wrapper">
                    <input
                        type="text"
                        id="geneA"
                        name="geneA"
                        placeholder="Enter first gene"
                        autocomplete="off"
                        required>
                    <div id="geneA-suggestions" class="gene-suggestions hidden"></div>
                </div>
            </div>

            <div class="form-field gene-input-line">
                <label for="geneB">Enter Gene B:</label>
                <div class="gene-input-wrapper">
                    <input
                        type="text"
                        id="geneB"
                        name="geneB"
                        placeholder="Enter second gene"
                        autocomplete="off"
                        required>
                    <div id="geneB-suggestions" class="gene-suggestions hidden"></div>
                </div>
            </div>

            <button type="submit" class="form-submit" id="generateCorrelationButton">
                <span class="label">Generate Correlation</span>
                <span class="loading-spinner" aria-hidden="true"></span>
            </button>
        </form>

        <div id="correlationResult" class="hidden">
            <div id="correlationPlot"></div>
            <div id="correlationStats" class="correlation-stats"></div>
        </div>
        <div id="correlationError" style="color: red;"></div>
    </section>

    <section class="heatmap-intro hidden" data-view-section="heatmap">
        <h2>RNA Expression Heatmap across Ovarian Precancerous Lesions</h2>
        <p>
            Build quick gene panels and preview how RNA expression patterns compare across precancer lesion groups.
        </p>
        <details class="how-to-details">
            <summary>üí° How to Use</summary>
            <div class="how-to-panel">
                <ol>
                    <li><strong>Select Type:</strong> Choose Epithelium, Stroma, or Both(Epithelium separated by groups with all stromal samples as comparison) to define the tissue compartment.</li>
                    <li><strong>Choose Grouping Variable:</strong> Select Molecular subtype or Diagnosis to group lesion samples.</li>
                    <li><strong>Enter Gene List:</strong> Provide official gene symbols separated by commas (e.g., IGFBP2, KIFC1, MMP7, CD74).</li>
                    <li><strong>Choose Scaling:</strong> Choose mean normalized counts for absolute expression or per-gene z-scores for relative highs and lows (color palette adjusts automatically).</li>
                    <li><strong>Generate Plot:</strong> Preview the heatmap to see how expression varies across lesion groups.</li>
                </ol>
            </div>
        </details>
    </section>

    <section id="heatmapSection" class="hidden">
        <form id="heatmapForm" onsubmit="generateHeatmap(); return false;">
            <div class="form-field">
                <label for="heatmapType">Select Type:</label>
                <select name="heatmapType" id="heatmapType">
                    <option value="epithelium">Epithelium</option>
                    <option value="stroma" selected>Stroma</option>
                    <option value="both">Both</option>
                </select>
            </div>
            <div class="form-field">
                <label for="heatmapCategory">Group By:</label>
                <select name="heatmapCategory" id="heatmapCategory">
                    <option value="molecular">Molecular subtype</option>
                    <option value="diagnosis" selected>Diagnosis</option>
                </select>
            </div>
            <div class="form-field gene-field">
                <label for="heatmapGenes">Enter Gene List:</label>
                <textarea id="heatmapGenes" name="heatmapGenes" rows="3" placeholder="IGFBP2, KIFC1, MMP7"></textarea>
            </div>
            <div class="form-field">
                <label for="heatmapScale">Choose Scaling:</label>
                <select id="heatmapScale" name="heatmapScale">
                    <option value="raw" selected>Mean normalized count</option>
                    <option value="zscore">Per-gene z-score</option>
                </select>
            </div>
            <button type="submit" class="form-submit" id="generateHeatmapButton">
                <span class="label">Generate Heatmap</span>
                <span class="loading-spinner" aria-hidden="true"></span>
            </button>
        </form>
        <div id="heatmapError" class="form-error"></div>
        <div class="heatmap-placeholder hidden" id="heatmapPlaceholder">
            Enter a list of genes to preview the heatmap.
        </div>
    </section>

    <div id="plot"></div>
    <div id="additionalPlot"></div>
    <div id="selectionPlot"></div>
    <div id="error" style="color: red;"></div>

    <section id="about" class="about-section hidden">
        <h2>About Us</h2>
        <p>We are from the JHU Ie-Ming Shih / Tian-Li Wang Lab.</p>
        <p>
            To learn more about our work, please visit
            <a href="https://gynecologycancer.org/" target="_blank" rel="noopener noreferrer">gynecologycancer.org</a>.
        </p>
    </section>

    <section id="contact" class="contact-section hidden">
        <h2>Contact Us</h2>
        <p>
            For website inquiries, please email
            <a href="mailto:precanceratlas@gmail.com">precanceratlas@gmail.com</a>.
        </p>
        <p>
            For collaborations or research questions, contact
            <a href="mailto:shihie@yahoo.com">shihie@yahoo.com</a>.
        </p>
    </section>

    <section id="citation" class="citation-section hidden">
        <h2>How to Cite</h2>
        <p>
            The data used for generating the plots on this website are derived from analyses described in the manuscript
            <strong><a href="https://pubmed.ncbi.nlm.nih.gov/41411622/" class="citation-link" target="_blank" rel="noopener noreferrer"><em>Integrated Spatial Analysis Reveals the Molecular Landscape of Ovarian Precancerous Lesions</em>, Chang et al.</a></strong>.
        </p>
        <div class="citation-box">
            <p id="citationText">Chang, Tu-Yung et al. ‚ÄúIntegrated Spatial Analysis Reveals the Molecular Landscape of Ovarian Precancerous Lesions.‚Äù Cancer research, 10.1158/0008-5472.CAN-25-3189. 18 Dec. 2025, doi:10.1158/0008-5472.CAN-25-3189</p>
            <button class="copy-btn" onclick="copyCitation()" aria-label="Copy citation">
                <svg class="icon-copy" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
                <svg class="icon-check hidden" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </button>
        </div>
        <p>
            If you use the Flat or BLAD morphology categories, please cite
            <strong><span class="citation-link"><em>Morphologic and Molecular Heterogeneity of High-grade Serous Carcinoma Precursor Lesions</em>, Chien et al.</span></strong>.
        </p>
    </section>
</main>

<script>
    function copyCitation() {
        // Get the text content, removing existing HTML tags logic if needed, but innerText is usually fine
        const citationNode = document.getElementById("citationText");
        const textToCopy = citationNode.innerText || citationNode.textContent;
        
        navigator.clipboard.writeText(textToCopy).then(() => {
            const btn = document.querySelector(".copy-btn");
            const copyIcon = btn.querySelector(".icon-copy");
            const checkIcon = btn.querySelector(".icon-check");

            copyIcon.classList.add("hidden");
            checkIcon.classList.remove("hidden");
            btn.classList.add("copied");

            setTimeout(() => {
                copyIcon.classList.remove("hidden");
                checkIcon.classList.add("hidden");
                btn.classList.remove("copied");
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy text: ', err);
        });
    }
</script>

    <footer class="site-disclaimer hidden" id="siteFooter">
        <p>All visualizations and analyses shown here are based on mRNA expression data generated using the NanoString GeoMx platform. These results are provided for research purposes only. All biological and clinical interpretations are not endorsed by the authors or affiliated institutions.</p>

        <p>All data used in the visualizations are fully de-identified and were analyzed in compliance with Institutional Review Board (IRB)‚Äìapproved protocols.</p>
    </footer>

    <script>
        const homeSection = document.getElementById("home");
        const expressionSection = document.getElementById("expressionSection");
        const correlationSection = document.getElementById("correlationSection");
        const heatmapSection = document.getElementById("heatmapSection");
        const aboutSection = document.getElementById("about");
        const contactSection = document.getElementById("contact");
        const citationSection = document.getElementById("citation");
        const expressionIntro = document.querySelector('[data-view-section="expression"]');
        const heatmapIntro = document.querySelector('[data-view-section="heatmap"]');
        const viewToggleLinks = document.querySelectorAll("[data-view-target]");
        const geneInput = document.getElementById("gene");
        const geneSuggestions = document.getElementById("gene-suggestions");
        const geneAInput = document.getElementById("geneA");
        const geneASuggestions = document.getElementById("geneA-suggestions");
        const geneBInput = document.getElementById("geneB");
        const geneBSuggestions = document.getElementById("geneB-suggestions");

        const categorySelect  = document.getElementById("corCategory");
        const categoryDetailWrapper = document.getElementById("categoryDetailWrapper");
        const categoryDetailDropdown = document.getElementById("categoryDetailDropdown");
        const categoryDetailOptions = document.getElementById("categoryDetailOptions");
        const categoryDetailSummary = document.getElementById("categoryDetailSummary");
        const correlationForm = document.getElementById("correlationForm");
        const correlationResult = document.getElementById("correlationResult");
        const correlationPlotDiv = document.getElementById("correlationPlot");
        const correlationStatsDiv = document.getElementById("correlationStats");
        const correlationError = document.getElementById("correlationError");
        const siteFooter = document.getElementById("siteFooter");
        const generatePlotButton = document.getElementById("generatePlotButton");
        const generateCorrelationButton = document.getElementById(
          "generateCorrelationButton"
        );
        const heatmapForm = document.getElementById("heatmapForm");
        const generateHeatmapButton = document.getElementById("generateHeatmapButton");
        const heatmapError = document.getElementById("heatmapError");
        const heatmapPlaceholder = document.getElementById("heatmapPlaceholder");

        function setupGeneAutocomplete(inputElement, suggestionElement) {
          if (!inputElement || !suggestionElement) {
            return;
          }

          const normalize = value => (value || "").trim().toUpperCase();
          let controller = null;

          const clear = () => {
            suggestionElement.innerHTML = "";
            suggestionElement.classList.add("hidden");
          };

          const show = names => {
            suggestionElement.innerHTML = "";
            if (!names || names.length === 0) {
              const empty = document.createElement("div");
              empty.className = "gene-suggestion empty";
              empty.textContent = "No matching genes";
              suggestionElement.appendChild(empty);
            } else {
              names.forEach(name => {
                const option = document.createElement("button");
                option.type = "button";
                option.className = "gene-suggestion";
                option.textContent = name;
                option.addEventListener("mousedown", event => {
                  event.preventDefault();
                  inputElement.value = name;
                  clear();
                });
                suggestionElement.appendChild(option);
              });
            }
            suggestionElement.classList.remove("hidden");
          };

          const update = term => {
            if (controller) {
              controller.abort();
              controller = null;
            }

            if (!term || term.length < 1) {
              clear();
              return;
            }

            const newController =
              typeof AbortController !== "undefined" ? new AbortController() : null;
            controller = newController;
            const fetchOptions = newController ? { signal: newController.signal } : {};

            fetch(`/genes?q=${encodeURIComponent(term)}`, fetchOptions)
              .then(res => (res.ok ? res.json() : []))
              .then(names => {
                show(names);
                controller = null;
              })
              .catch(err => {
                if (!err || err.name !== "AbortError") {
                  console.error("Gene suggestion lookup failed", err);
                }
                controller = null;
                clear();
              });
          };

          inputElement.addEventListener("input", event => {
            const value = normalize(event.target.value);
            if (event.target.value !== value) {
              event.target.value = value;
            }
            update(value);
          });

          inputElement.addEventListener("focus", event => {
            const value = normalize(event.target.value);
            if (event.target.value !== value) {
              event.target.value = value;
            }
            update(value);
          });

          inputElement.addEventListener("blur", () => {
            setTimeout(() => {
              clear();
            }, 120);
          });
        }

        setupGeneAutocomplete(geneInput, geneSuggestions);
        setupGeneAutocomplete(geneAInput, geneASuggestions);
        setupGeneAutocomplete(geneBInput, geneBSuggestions);

        function resetCorrelationOutput(clearError = true) {
          if (correlationPlotDiv) {
            correlationPlotDiv.innerHTML = "";
          }
          if (correlationStatsDiv) {
            correlationStatsDiv.textContent = "";
          }
          if (correlationResult) {
            correlationResult.classList.add("hidden");
            correlationResult.classList.remove("has-content");
          }
          if (clearError && correlationError) {
            correlationError.textContent = "";
          }
        }

        function setPlotContainerContent(element, html) {
          if (!element) return;
          if (html) {
            element.innerHTML = html;
            element.classList.add("has-content");
          } else {
            element.innerHTML = "";
            element.classList.remove("has-content");
          }
        }

        function clearExpressionPlots() {
          setPlotContainerContent(document.getElementById("plot"), "");
          setPlotContainerContent(document.getElementById("additionalPlot"), "");
          setPlotContainerContent(document.getElementById("selectionPlot"), "");
        }

        function setViewMode(mode, { scrollIntoView = true } = {}) {
          let normalized = "expression";
          if (mode === "home") {
            normalized = "home";
          } else if (mode === "correlation") {
            normalized = "correlation";
          } else if (mode === "heatmap") {
            normalized = "heatmap";
          } else if (mode === "about") {
            normalized = "about";
          } else if (mode === "citation") {
            normalized = "citation";
          } else if (mode === "contact") {
            normalized = "contact";
          }

          const showHome = normalized === "home";
          const showExpression = normalized === "expression";
          const showCorrelation = normalized === "correlation";
          const showHeatmap = normalized === "heatmap";
          const showAbout = normalized === "about";
          const showContactOnly = normalized === "contact";
          const showContact = showAbout || showContactOnly;
          const showCitation = normalized === "citation";

          if (homeSection) {
            homeSection.classList.toggle("hidden", !showHome);
          }
          if (expressionIntro) {
            expressionIntro.classList.toggle("hidden", !showExpression);
          }
          if (expressionSection) {
            expressionSection.classList.toggle("hidden", !showExpression);
          }
          if (correlationSection) {
            correlationSection.classList.toggle("hidden", !showCorrelation);
          }
          if (heatmapIntro) {
            heatmapIntro.classList.toggle("hidden", !showHeatmap);
          }
          if (heatmapSection) {
            heatmapSection.classList.toggle("hidden", !showHeatmap);
          }
          if (aboutSection) {
            aboutSection.classList.toggle("hidden", !showAbout);
          }
          if (contactSection) {
            contactSection.classList.toggle("hidden", !showContact);
          }
          if (citationSection) {
            citationSection.classList.toggle("hidden", !showCitation);
          }
        if (siteFooter) {
            const shouldShowFooter = showExpression || showCorrelation || showHeatmap;
            siteFooter.classList.toggle("hidden", !shouldShowFooter);
            if (shouldShowFooter) {
              siteFooter.classList.add("has-background");
            } else {
              siteFooter.classList.remove("has-background");
            }
          }

          if (!showExpression) {
            clearExpressionPlots();
          }
          if (!showCorrelation) {
            resetCorrelationOutput(true);
          }
          if (heatmapPlaceholder && !showHeatmap) {
            heatmapPlaceholder.classList.add("hidden");
          } else if (heatmapPlaceholder && showHeatmap) {
            heatmapPlaceholder.classList.remove("hidden");
          }

          if (scrollIntoView) {
            let target = null;
            if (showExpression) {
              target = expressionSection;
            } else if (showCorrelation) {
              target = correlationSection;
            } else if (showHeatmap) {
              target = heatmapSection;
            } else if (showHome) {
              target = homeSection;
            } else if (showAbout) {
              target = aboutSection;
            } else if (showContactOnly) {
              target = contactSection;
            } else if (showCitation) {
              target = citationSection;
            }
            if (target) {
              target.scrollIntoView({ behavior: "smooth", block: "start" });
            }
          }
        }

        viewToggleLinks.forEach(link => {
          link.addEventListener("click", event => {
            const targetView = event.currentTarget.dataset.viewTarget;
            if (!targetView) {
              return;
            }
            event.preventDefault();
            setViewMode(targetView, { scrollIntoView: false });
            if (typeof event.currentTarget.blur === "function") {
              event.currentTarget.blur();
            }
            const dropdownParent = event.currentTarget.closest(".nav-item--has-dropdown");
            if (dropdownParent) {
              const toggleButton = dropdownParent.querySelector(".dropdown-toggle");
              if (toggleButton && typeof toggleButton.blur === "function") {
                toggleButton.blur();
              }
            }
          });
        });

        setViewMode("home", { scrollIntoView: false });

        const categoryDetails = {
          molecular: [
            { value: "NFT", label: "NFT" },
            { value: "Dormant", label: "Dormant" },
            { value: "Mixed", label: "Mixed" },
            { value: "Immunoreactive", label: "Immunoreactive" },
            { value: "Proliferative", label: "Proliferative" },
            { value: "HGSC", label: "HGSC" }
          ],
          morphology: [
            { value: "Flat", label: "Flat" },
            { value: "BLAD", label: "BLAD" }
          ],
          brca: [
            { value: "BRCA1", label: "BRCA1" },
            { value: "BRCA2", label: "BRCA2" },
            { value: "Negative", label: "Negative" },
            { value: "Other", label: "Other" }
          ],
          diagnosis: [
            { value: "NFT", label: "NFT" },
            { value: "p53 sig", label: "p53 signature" },
            { value: "STIL", label: "STIL" },
            { value: "STIC", label: "STIC" },
            { value: "HGSC", label: "HGSC" }
          ]
        };

        function resetCategoryDetail() {

          categoryDetailOptions.innerHTML = "";
          categoryDetailSummary.textContent = "Select group(s)";
          if (categoryDetailDropdown) {
            categoryDetailDropdown.open = false;
          }
          categoryDetailWrapper.classList.add("hidden");
        }

        function getSelectedDetailInputs() {
          if (!categoryDetailOptions) {
            return [];
          }
          return Array.from(
            categoryDetailOptions.querySelectorAll('input[type="checkbox"]:checked')
          );
        }

        function getSelectedDetailValues() {
          return getSelectedDetailInputs()
            .filter(input => input.name === "category_detail")
            .map(input => input.value);
        }

        function syncSelectAllState() {
          if (!categoryDetailOptions) {
            return;
          }
          const selectAllCheckbox = categoryDetailOptions.querySelector(
            'input[type="checkbox"][name="category_detail_all"]'
          );
          if (!selectAllCheckbox) {
            return;
          }
          const detailCheckboxes = categoryDetailOptions.querySelectorAll(
            'input[type="checkbox"][name="category_detail"]'
          );
          if (!detailCheckboxes.length) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
            return;
          }
          const checkedCount = Array.from(detailCheckboxes).filter(cb => cb.checked).length;
          selectAllCheckbox.checked = checkedCount === detailCheckboxes.length;
          selectAllCheckbox.indeterminate =
            checkedCount > 0 && checkedCount < detailCheckboxes.length;
        }

        function updateCategoryDetailSummary() {
          const checkedInputs = getSelectedDetailInputs();
          const selectAllCheckbox = categoryDetailOptions
            ? categoryDetailOptions.querySelector('input[type="checkbox"][name="category_detail_all"]')
            : null;
          const selectAllChecked = selectAllCheckbox ? selectAllCheckbox.checked : false;

          const detailInputs = checkedInputs.filter(
            input => input.name === "category_detail"
          );
          if (selectAllChecked && detailInputs.length > 0) {
            categoryDetailSummary.textContent = "All selected";
            return;
          }

          const labels = detailInputs.map(
            input => input.dataset.label || input.value
          );
          if (labels.length === 0) {
            categoryDetailSummary.textContent = "Select group(s)";
          } else if (labels.length <= 2) {
            categoryDetailSummary.textContent = labels.join(", ");
          } else {
            categoryDetailSummary.textContent = `${labels.length} selected`;
          }
        }

        function populateCategoryDetail(items) {
          const previousInputs = getSelectedDetailInputs();
          const previouslySelected = new Set(
            previousInputs
              .filter(input => input.name === "category_detail")
              .map(input => input.value)
          );
          const previousSelectAll = previousInputs.some(
            input =>
              input.name === "category_detail_all" &&
              typeof input.checked === "boolean" &&
              input.checked
          );

          categoryDetailOptions.innerHTML = "";
          let selectAllCheckbox = null;

          if (items.length > 0) {
            const selectAllLabel = document.createElement("label");
            selectAllLabel.className = "multi-option select-all-option";

            selectAllCheckbox = document.createElement("input");
            selectAllCheckbox.type = "checkbox";
            selectAllCheckbox.name = "category_detail_all";
            selectAllCheckbox.value = "*";
            selectAllCheckbox.dataset.label = "Select all";
            selectAllCheckbox.checked =
              previousSelectAll || previouslySelected.size === items.length;
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.addEventListener("change", event => {
              const checked = event.target.checked;
              categoryDetailOptions
                .querySelectorAll('input[type="checkbox"][name="category_detail"]')
                .forEach(cb => {
                  cb.checked = checked;
                });
              updateCategoryDetailSummary();
              syncSelectAllState();
            });

            const allSpan = document.createElement("span");
            allSpan.textContent = "Select all";

            selectAllLabel.appendChild(selectAllCheckbox);
            selectAllLabel.appendChild(allSpan);
            categoryDetailOptions.appendChild(selectAllLabel);
          }

          items.forEach(item => {
            const optionLabel = document.createElement("label");
            optionLabel.className = "multi-option";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.name = "category_detail";
            checkbox.value = item.value;
            checkbox.dataset.label = item.label;
            if (
              (selectAllCheckbox && selectAllCheckbox.checked) ||
              previouslySelected.has(item.value)
            ) {
              checkbox.checked = true;
            }
            checkbox.addEventListener("change", () => {
              updateCategoryDetailSummary();
              syncSelectAllState();
            });

            const span = document.createElement("span");
            span.textContent = item.label;

            optionLabel.appendChild(checkbox);
            optionLabel.appendChild(span);
            categoryDetailOptions.appendChild(optionLabel);
          });

          syncSelectAllState();
          updateCategoryDetailSummary();
          if (categoryDetailDropdown) {
            categoryDetailDropdown.open = false;
          }
          categoryDetailWrapper.classList.remove("hidden");
        }

        function refreshCategoryDetail() {
          const value = categorySelect.value;
          if (categoryDetails[value] && categoryDetails[value].length > 0) {
            populateCategoryDetail(categoryDetails[value]);
          } else {
            resetCategoryDetail();
          }
          resetCorrelationOutput(false);
        }

        categorySelect.addEventListener("change", refreshCategoryDetail);

        resetCategoryDetail();
        refreshCategoryDetail();

        document.addEventListener("click", event => {
          if (
            categoryDetailDropdown &&
            categoryDetailDropdown.open &&
            !categoryDetailDropdown.contains(event.target)
          ) {
            categoryDetailDropdown.open = false;
          }
        });

        function generateCorrelation() {
          if (!geneAInput || !geneBInput) {
            return false;
          }

          const geneAValue = (geneAInput.value || "").trim().toUpperCase();
          const geneBValue = (geneBInput.value || "").trim().toUpperCase();
          geneAInput.value = geneAValue;
          geneBInput.value = geneBValue;

          if (!geneAValue || !geneBValue) {
            correlationError.textContent = "Please enter both gene names.";
            return false;
          }

          const formData = new FormData();
          formData.append("geneA", geneAValue);
          formData.append("geneB", geneBValue);
          formData.append("type", "epithelium");

          const categoryValue = categorySelect ? categorySelect.value : "";
          if (categoryValue) {
            formData.append("category", categoryValue);
          }

          const detailValues = getSelectedDetailValues();
          const requiresDetail =
            categoryDetailWrapper &&
            !categoryDetailWrapper.classList.contains("hidden") &&
            detailValues.length === 0;

          if (requiresDetail) {
            correlationError.textContent =
              "Please select at least one detail option.";
            return false;
          }

          detailValues.forEach(value => formData.append("category_detail", value));

          resetCorrelationOutput(true);
          if (categoryDetailDropdown) {
            categoryDetailDropdown.open = false;
          }

          if (generateCorrelationButton) {
            generateCorrelationButton.disabled = true;
            generateCorrelationButton.classList.add("is-loading");
          }

          fetch("/pre_cancer_correlation", {
            method: "POST",
            body: formData
          })
            .then(res => {
              if (res.ok) {
                return res.json();
              }
              return res
                .json()
                .catch(() => ({}))
                .then(body => {
                  const message =
                    body && typeof body.error === "string"
                      ? body.error
                      : "Unable to generate correlation.";
                  throw new Error(message);
                });
            })
            .then(data => {
              if (!data || !data.plot_url) {
                throw new Error("Correlation plot is unavailable.");
              }
              correlationPlotDiv.innerHTML =
                `<img src="${data.plot_url}" alt="Correlation plot" class="correlation-image">`;
              const fragments = [];
              if (data.stats_text) {
                fragments.push(`<span class="stat-line">${data.stats_text}</span>`);
              }
              if (data.summary) {
                const summaryParts = (data.summary || "").split(";");
                summaryParts
                  .map(part => part.trim())
                  .filter(Boolean)
                  .forEach(part => {
                    fragments.push(`<span class="stat-line">${part}</span>`);
                  });
              }
              correlationStatsDiv.innerHTML = fragments.join("");
              correlationResult.classList.remove("hidden");
              correlationResult.classList.add("has-content");
              correlationError.textContent = "";
            })
            .catch(err => {
              correlationError.textContent =
                err && err.message
                  ? err.message
                  : "Unable to generate correlation.";
              if (correlationResult) {
                correlationResult.classList.remove("has-content");
              }
            })
            .finally(() => {
              if (generateCorrelationButton) {
                generateCorrelationButton.disabled = false;
                generateCorrelationButton.classList.remove("is-loading");
              }
            });

          return false;
        }

        function generatePlot() {
          const form      = document.getElementById("plotForm");
          const geneValue = (geneInput.value || "").trim().toUpperCase();
          geneInput.value = geneValue;

          const formData = new FormData(form);
          const selCat   = formData.get("selection") || "";
          formData.set("gene", geneValue);

          if (generatePlotButton) {
            generatePlotButton.disabled = true;
            generatePlotButton.classList.add("is-loading");
          }
      
          fetch("/pre_cancer_atlas", {
            method: "POST",
            body: formData
          })
          .then(res => {
            if (!res.ok) {
              return res.json().then(j => { throw new Error(j.error); });
            }
            return res.json();
          })
          .then(data => {
            const plotDiv = document.getElementById("plot");
            setPlotContainerContent(
              plotDiv,
              `<img src="${data.plot_url1}" alt="Boxplot of Pathologic Diagnosis">`
            );

            const secondDiv = document.getElementById("additionalPlot");
            const thirdDiv = document.getElementById("selectionPlot");
            setPlotContainerContent(secondDiv, "");
            setPlotContainerContent(thirdDiv, "");

            if (typeof data.plot_url2 === "string" && data.plot_url2.startsWith("data:image")) {
              setPlotContainerContent(
                secondDiv,
                `<img src="${data.plot_url2}" alt="Boxplot of Molecular Subtype">`
              );
            }

            if (
              typeof data.plot_url3 === "string" &&
              data.plot_url3.startsWith("data:image")
            ) {
              const label = selCat ? selCat : "Selected category";
              setPlotContainerContent(
                thirdDiv,
                `<img src="${data.plot_url3}" alt="Boxplot of ${label}">`
              );
            }

            // Clear any error
            document.getElementById("error").innerText = "";
          })
          .catch(err => {
            setPlotContainerContent(document.getElementById("plot"), "");
            setPlotContainerContent(document.getElementById("additionalPlot"), "");
            setPlotContainerContent(document.getElementById("selectionPlot"), "");
            document.getElementById("error").innerText         = err.message;
          })
          .finally(() => {
            if (generatePlotButton) {
              generatePlotButton.disabled = false;
              generatePlotButton.classList.remove("is-loading");
            }
          });
        }

        function generateHeatmap() {
          if (!heatmapForm) {
            return false;
          }
          if (heatmapError) {
            heatmapError.textContent = "";
          }
          const formData = new FormData(heatmapForm);
          if (generateHeatmapButton) {
            generateHeatmapButton.disabled = true;
            generateHeatmapButton.classList.add("is-loading");
          }
          fetch("/pre_cancer_heatmap", {
            method: "POST",
            body: formData,
          })
            .then(res => {
              if (!res.ok) {
                return res.json().then(payload => {
                  throw new Error(
                    payload && payload.error ? payload.error : "Unable to generate heatmap."
                  );
                });
              }
              return res.json();
            })
            .then(data => {
              const groupSummary = Array.isArray(data.group_stats) && data.group_stats.length
                ? `<p class="heatmap-note">Group counts: ${data.group_stats.join("; ")}</p>`
                : "";
              const missing =
                Array.isArray(data.missing_genes) && data.missing_genes.length
                  ? `<p class="heatmap-note">Not in database: ${data.missing_genes.join(", ")}</p>`
                  : "";
              const scaleNote = data.scale_label
                ? `<p class="heatmap-note">Scale: ${data.scale_label}</p>`
                : "";
              if (heatmapPlaceholder) {
                heatmapPlaceholder.classList.remove("hidden");
                if (data.heatmap_url) {
                  heatmapPlaceholder.innerHTML = `
                    <img src="${data.heatmap_url}" alt="RNA expression heatmap" class="heatmap-image">
                    ${groupSummary}
                    ${scaleNote}
                    ${missing}
                  `;
                } else {
                  heatmapPlaceholder.innerHTML = groupSummary || scaleNote || missing || "No heatmap image returned.";
                }
              }
            })
            .catch(err => {
              if (heatmapError) {
                heatmapError.textContent =
                  err && err.message ? err.message : "Unable to generate heatmap.";
              }
            })
            .finally(() => {
              if (generateHeatmapButton) {
                generateHeatmapButton.disabled = false;
                generateHeatmapButton.classList.remove("is-loading");
              }
            });
          return false;
        }

        // Mobile dropdown toggle for Gene Explore
        (function () {
          const dropdownParents = Array.from(
            document.querySelectorAll(".nav-item--has-dropdown")
          );
          if (!dropdownParents.length) {
            return;
          }

          dropdownParents.forEach(parent => {
            const trigger =
              parent.querySelector(".dropdown-toggle") ||
              parent.querySelector(".nav-link");
            if (!trigger) {
              return;
            }
            trigger.addEventListener("click", event => {
              event.preventDefault();
              const isOpen = parent.classList.contains("is-open");
              dropdownParents.forEach(item => item.classList.remove("is-open"));
              if (!isOpen) {
                parent.classList.add("is-open");
              }
            });

            parent.querySelectorAll(".nav-dropdown .nav-link").forEach(link => {
              link.addEventListener("click", () => {
                dropdownParents.forEach(item => item.classList.remove("is-open"));
              });
            });
          });

          document.addEventListener("click", event => {
            if (!event.target.closest(".nav-item--has-dropdown")) {
              dropdownParents.forEach(item => item.classList.remove("is-open"));
            }
          });

          document.addEventListener("keydown", event => {
            if (event.key === "Escape") {
              dropdownParents.forEach(item => item.classList.remove("is-open"));
            }
          });
        })();
      </script>
</body>
</html>
